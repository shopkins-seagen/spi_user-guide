.. include:: nav.rst

Create the Specification File
==========================================
The application uses a specification file created by the mcr_spi_sdtm_crf_annotator macro to annotate the CRF. The macro accepts the Study Data Specification(SDS) file 
and CRF tree as the source of the Rave metadata needed to identify the forms and fields on the unique CRFs. The macro generates the specification file with all the fields 
that are required by the annotation macro. The programmer is responsible for completing the Domain and SDTM Annotation fields in the specification file. To make this 
easier for the programmer,  a SQL database is maintained by SPI with mappings of Rave -> SDTM annotations. Over time, the DB will become more complete as new studies are
processed and more mappings are available, decreasing the amount of manual work for programming. 

Calling the macro
-------------------
Use the mcr_spi_crf_annotator macro with the action=S argument, passing the SDS and CRF tree to  the macro. The macro creates a new spec_file that will be updated 
by the programmer to include the SDMT domain and annotations for each form to be included. 

.. code::

      %mcr_spi_sdtm_crf_annotator(
         spec_file   =O:\stat_prog_infra\testing\crf-annotator\dotnet\src\docs\crfs\sgnb7h4v\new-specs.xlsx  
        ,in_crf_tree =O:\stat_prog_infra\testing\crf-annotator\dotnet\src\docs\crfs\sgnb7h4v\tree.xlsx
        ,in_sds      =O:\stat_prog_infra\testing\crf-annotator\dotnet\src\docs\crfs\sgnb7h4v\sds.xlsx
        ,action      =S);

Specification File 
------------------------------
The specification file contains the information needed to apply the SDTM annotations to the location on the unique CRF pdf document. The Rave data is 
provided by the SDS and CRF tree workbooks. The SDTM data is the responsibility of the programmer. The application pre-fills the Domain and SDTM 
annotation columns as available in the database. 

.. list-table:: 
  :widths: 20 80
  :header-rows: 1

  * - Worksheet
    - Columns
  * - Crf
    - .. list-table:: 
        :widths: 20 80
        :header-rows: 1
        
        * - Field
          - Description
        * - FormID
          - ID of the form from the Rave SDS file. Used for reference          
        * - Form
          - Name of the form. Used to locate the form in the unique CRF pdf.
        * - Field
          - Raw EDC variable name. Use for reference.
        * - Label
          - Full label for the field displayed on the CRF.
        * - Target
          - Shortened label used by the app to target the field on the CRF during annotation.
        * - Domain
          - SDTM domain that captures the data point. If a mapping is not in the database, the programmer is repsonsible for entering.
        * - Annotation
          - SDTM annotation to display on the CRF. If a mapping is not in the database, the programmer is repsonsible for entering.
        * - Offset
          - In the event there are multiple annotations for the same combination of Form + Target, increment the offset by 1 for each additional annotation.

  * - Visits
    - .. list-table:: 
        :widths: 20 80
        :header-rows: 1
        
        * - Field
          - Description
        * - Visit
          - Name of the visit used in the Visits bookmarks        
        * - Form
          - Name of the form used within the visit node of the Visits bookmarks        

.. note:: 

    The sequence of the records in the Visits worksheet determines the order of the Visits bookmarks. Programmers can alter the order and content of the Visits
    worksheet as needed.                          

The SDS spreadsheet
-------------------------------
This spreadsheet generated by the EDC programmer is available from the DM. It contains the metadata for the Rave eCRF. 

.. list-table:: 
  :widths: 20 80
  :header-rows: 1

  * - Worksheet
    - Columns
  * - Forms
    - .. list-table:: 
        :widths: 20 80
        :header-rows: 1
        
        * - Field
          - Description
        * - OID
          - ID of the form
        * - Ordinal
          - Position of the form in the eCRF
        * - DraftFormName
          - The name of the form in the eCRF. This is the target the app uses to locate the form during annotation. RGX_FORM_PREFIX in the 
            mcr_spi_crf_annotator identifies the pattern that preceeds form name.           

  * - Fields
    - .. list-table:: 
        :widths: 20 80
        :header-rows: 1
        
        * - Field
          - Description
        * - FormOID
          - ID of the form. Used to link to the Forms sheet
        * - FieldOID
          - Field name of the raw variable. This is used in combination with FormOID to link the SDTM annotation to specific Rave fields in the database.
        * - Ordinal
          - Position of the field within the form
        * - SasLabel
          - Used as a target to apply the annotation when generating the aCRF

  * - Visits
    - .. list-table:: 
        :widths: 20 80
        :header-rows: 1
        
        * - Field
          - Description
        * - OID
          - The ID of the visit. Used to link to the CRF_Tree to indentify forms associated with a particular visit.
        * - Ordinal
          - Identifies the order of the visit within the eCRF. 
        * - FolderName
          - Full name of the visit. Used to build the visit bookmarks.         

The CRF Tree spreadsheet
----------------------------------
The CRF Tree is used to create the visit book marks. The order of the bookmarks is defined by the position of the record in the CRF tree worksheet. 

.. list-table:: 
  :widths: 20 80
  :header-rows: 1

  * - Worksheet
    - Columns
  * - CRF\\\\s*Tree 
    - .. list-table:: 
        :widths: 20 80
        :header-rows: 1
        
        * - Field
          - Description
        * - Folder OID
          - ID of the visit. Used to match to the SDS visit to get the full visit name
        * - Form Name
          - Name of the form
        * - Form OID
          - ID of the form used to link to the SDS data

.. note:: 

    Due to variability in the worksheet name in the CRF tree spreadsheet, the app uses pattern matching instead of a static string.

